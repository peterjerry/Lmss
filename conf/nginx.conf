user root;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;
error_log   /data/logs/lmss/error.log  debug;

#pid        logs/lmss.pid;

worker_rlimit_core  500M;
working_directory   /usr/local/lmss/core/;
rtmp_socket_dir     /dev/shm;

events {
    worker_connections  10240;
}

rtmp{
    include                lmss.info;
    load_conf_from         local;
    billing                on;
    billing_interval       1m;
    billing_path           /data/logs/lmss/;
    on_connect             http://localhost:8080/connect;
    on_publish             http://localhost:8080/publish;
    on_play                http://localhost:8080/play;
    on_update              http://localhost:8080/update;
    on_publish_done        http://localhost:8080/publish_done;

    server {
        listen 1935 so_keepalive=1:2:3;
        rtmp_publish_domains test.uplive.ks-cdn.com;
        rtmp_play_domains    test.rtmplive.ks-cdn.com test.live.ks-cdn.com;
        hls_play_domains     test.hlslive.ks-cdn.com test.live.ks-cdn.com;
        hdl_play_domains     test.hdllive.ks-cdn.com test.live.ks-cdn.com;
        unique_name          test;
        idle_timeout         20s;
        application live {
            hdl                 on;

            hls                 on;
            hls_fragment        5s;
            hls_playlist_length 15s;

            hls_vod               on;
            hls_vod_usr_id        73402272;
    	    hls_vod_is_public     1;
            hls_vod_bucket        test-huzilong;
            hls_vod_url           test.com;

            recorder picture {
                record video      keyframes;
                record_max_frames 1;
                record_usr_id     73402272;
                record_is_public  1;
                record_bucket     test-huzilong;
                record_path       /data/picture;
                record_interval   6s;
            }

            recorder vod {
                record all;
                record_usr_id     73402272;
                record_is_public  1;
                record_bucket     test-huzilong;
                record_path       /data/vod_flv;
                record_interval   6s;
                record_notify_url test.com;
            }
        }
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format    main  '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

    access_log    /data/logs/lmss/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    include       lmds.info;

    server {
        listen 8080;

        location / {
            hls  on;
            hdl  on;
            root /dev/shm;

            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            add_header Access-Control-Allow-Origin *;
        }

        # This URL provides RTMP statistics in XML
        location /stat {
            rtmp_stat all;

            # Use this stylesheet to view XML as web page
            # in browser
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            # XML stylesheet to view RTMP stats.
            # Copy stat.xsl wherever you want
            # and put the full directory path here
            root /usr/local/lmss/conf/;
        }

        location /control {
            rtmp_control all;
        }
        
        location =/connect {
            proxy_set_header Host $host;
            proxy_pass http://lmds/connect;
        }

        location =/publish {
            proxy_set_header Host $host;
            proxy_pass http://lmds/publish;
        }

        location =/play {
            proxy_set_header Host $host;
            proxy_pass http://lmds/play;
        }

        location =/update {
            proxy_set_header Host $host;
            proxy_pass http://lmds/update;
        }

        location =/publish_done {
            proxy_set_header Host $host;
            proxy_pass http://lmds/publish_done;
        }
    }
}
